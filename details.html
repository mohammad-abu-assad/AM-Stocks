<!DOCTYPE html>
<html>

<head>
  <title>Stock Details</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #000;
    }

    h1 {
      text-align: center;
      color: #FFF;
    }

    #chart {
      margin-top: 20px;
      background-color: #ffffff !important;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 100%;
    }

    .chart-container {
      padding: 20px;
    }
  </style>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
</head>

<body>
  <div class="container">
    <h1 id="test">Stock Details</h1>

    <div class="chart-container">
      <div id="chart"></div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    $(document).ready(function () {
       // Function to fetch stock data from IEX Cloud API
       function fetchStockData(symbol) {
        const apiKey = window.localStorage.getItem('apiKey');
        //const apiKey = 'sk_759f1a81608e49d1af9130765676c324'; // Replace with your IEX Cloud API key
        const apiUrl = `https://cloud.iexapis.com/stable/stock/${symbol}/chart/5y?token=${apiKey}`;

        return fetch(apiUrl)
          .then(response => response.json())
          .then(data => {
            if (data && data.length > 0) {
              const stockData = {
                symbol: symbol,
                dates: data.map(entry => entry.date),
                prices: data.map(entry => entry.close)
              };

              return stockData;
            } else {
              throw new Error("Invalid stock symbol");
            }
          });
      }

      // Function to create a chart for the stock
      function createStockChart(stockData) {
        const chartElement = document.getElementById("chart");

        const trace = {
          x: stockData.dates,
          y: stockData.prices,
          type: 'scatter',
          mode: 'lines',
          name: 'Stock Price'
        };

        const data = [trace];

        const layout = {
          title: `Stock Performance - ${stockData.symbol}`,
          xaxis: {
            title: 'Date',
            tickformat: '%Y-%m-%d'
          },
          yaxis: {
            title: 'Price'
          }
        };

        Plotly.newPlot(chartElement, data, layout);
      }
      
      // Get the stock symbol from the query string parameter
      const symbol = window.localStorage.getItem('symbol');
      


      if (symbol !== null) {
        // Fetch stock data and create the chart
        fetchStockData(symbol)
          .then(stockData => {
            createStockChart(stockData);
          })
          .catch(error => {
            console.log("Error:", error);
            alert("Failed to fetch stock data. Please try again later.");
          });
      } else {
        alert("Invalid stock symbol. Please provide a valid symbol.");
      }

    });
  </script>
</body>

</html>